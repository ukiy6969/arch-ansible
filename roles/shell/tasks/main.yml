---
- name: Install Zsh
  pacman:
    name: ['zsh', 'zsh-completions']
    state: present

- name: Change Shell
  user:
    name: "{{ user.name }}"
    shell: /bin/zsh
    append: yes

- name: Locale
  lineinfile:
    path: /etc/locale.gen
    regexp: '^#({{ user.locale }}.*)'
    line: '\1'
    state: present
    backrefs: yes

- name: Locale Gen
  locale_gen:
    name: "{{ user.locale }}"
    state: present

- name: Set User Locale
  copy:
    dest: "{{ user.home }}/.config/locale.conf"
    content: "LANG={{ user.locale }}"

- name: Install Tools
  pacman:
    name:
      - git
      - binutils
      - make
      - base-devel
      - htop
      - tmux
      - python-pip
      - python2-pip
    state: present

- name: Check is yay installed
  shell: command -v yay >/dev/null 2>&1
  register: is_yay_exist
  ignore_errors: yes
  changed_when: False

- debug: msg="{{ is_yay_exist.rc }}" # it returns rc 1
- debug: var=is_rvm_exist

- name: Git clone Yay
  git:
    repo: "https://aur.archlinux.org/yay.git"
    dest: "{{ user.home }}/.build/yay/"
  become: yes
  become_user: "{{ user.name }}"
  when: is_yay_exist is failed

- name: Build Yay
  command: "makepkg -si --noconfirm"
  args:
    chdir: "{{ user.home }}/.build/yay"
  become: yes
  become_user: "{{ user.name }}"
  when: is_yay_exist is failed

- name: Install Dev tools
  pacman:
    name:
      - nodejs
    state: present

- name: Install Neovim
  yay:
    name:
      - neovim
      - python2-neovim
      - python-neovim
      - ruby-neovim
      - nodejs-neovim
    state: present

- name: Install Ensime requirements
  pip:
    name:
      - websocket-client
      - sexpdata
    executable: pip2
    state: present

- name: Install Dotfiles
  git:
    repo: "https://github.com/ukiy6969/dotfiles.git"
    dest: "{{ user.home }}/dotfiles"
    force: yes
  register: dotfiles_status
  become: yes
  become_user: "{{ user.name }}"

- name: Link Dotfiles
  command: "{{ user.shell}} install.sh"
  args:
    chdir: "{{ user.home }}/dotfiles"
  become: yes
  become_user: "{{ user.name }}"
  when: "dotfiles_status.changed"

- name: Scala tools
  pacman:
    name: sbt
    state: present
